-- ================================================================
-- DATABASE MIGRATION SCRIPT (v12) - Daily Analytics
-- ================================================================
-- This script adds a function to retrieve daily analytics data
-- for the business dashboard over the last 7 days.
-- ================================================================

-- Step 1: Create a composite type to define the structure of the returned rows.
DROP TYPE IF EXISTS public.daily_stat CASCADE;
CREATE TYPE public.daily_stat AS (
    log_date date,
    new_members_count integer,
    points_awarded_sum integer,
    rewards_claimed_count integer
);

-- Step 2: Create or replace the function to get daily analytics.
CREATE OR REPLACE FUNCTION get_daily_analytics_7d(p_business_id uuid)
RETURNS SETOF public.daily_stat AS $$
WITH date_series AS (
    -- Generates a series of the last 7 dates, ending today.
    SELECT generate_series(
        CURRENT_DATE - INTERVAL '6 days',
        CURRENT_DATE,
        '1 day'
    )::date AS log_date
),
daily_members AS (
    -- Counts new members per day for the given business.
    SELECT
        created_at::date AS log_date,
        COUNT(*)::integer AS new_members_count
    FROM
        public.memberships
    WHERE
        business_id = p_business_id
        AND created_at >= CURRENT_DATE - INTERVAL '6 days'
    GROUP BY
        created_at::date
),
daily_scans AS (
    -- Aggregates points and rewards from scan logs per day.
    SELECT
        created_at::date AS log_date,
        SUM(points_awarded)::integer AS points_awarded_sum,
        COUNT(CASE WHEN reward_claimed THEN 1 END)::integer AS rewards_claimed_count
    FROM
        public.scan_logs
    WHERE
        business_id = p_business_id
        AND created_at >= CURRENT_DATE - INTERVAL '6 days'
    GROUP BY
        created_at::date
)
-- Final SELECT joins all data sources, filling in missing days with zeros.
SELECT
    d.log_date,
    COALESCE(m.new_members_count, 0) AS new_members_count,
    COALESCE(s.points_awarded_sum, 0) AS points_awarded_sum,
    COALESCE(s.rewards_claimed_count, 0) AS rewards_claimed_count
FROM
    date_series d
LEFT JOIN
    daily_members m ON d.log_date = m.log_date
LEFT JOIN
    daily_scans s ON d.log_date = s.log_date
ORDER BY
    d.log_date;
$$ LANGUAGE sql STABLE;

-- ================================================================
-- MIGRATION COMPLETE
-- ================================================================

-- APPENDING PREVIOUS MIGRATION FOR COMPLETENESS --

-- ================================================================
-- DATABASE MIGRATION SCRIPT (v11) - PFP Upload Fix & Product Removal
-- ================================================================
-- This script fixes profile picture uploads by setting up the
-- storage bucket and its policies. It also removes the deprecated
-- 'shop'/'products' feature.
-- ================================================================

-- Step 1: Create the storage bucket for profile pictures if it doesn't exist.
-- Make it public so anyone can view the images.
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES ('profile-pictures', 'profile-pictures', true, 5242880, ARRAY['image/jpeg', 'image/png', 'image/webp', 'image/gif'])
ON CONFLICT (id) DO UPDATE SET public = true, file_size_limit = 5242880, allowed_mime_types = ARRAY['image/jpeg', 'image/png', 'image/webp', 'image/gif'];


-- Step 2: Set up Row Level Security (RLS) policies for the bucket.
-- These policies allow anyone (anon role) to perform actions on the bucket.

-- Drop existing policies if they exist to ensure a clean slate
DROP POLICY IF EXISTS "Public Read Access" ON storage.objects;
DROP POLICY IF EXISTS "Public Insert Access" ON storage.objects;
DROP POLICY IF EXISTS "Public Update Access" ON storage.objects;


-- Allow anyone to view files in the 'profile-pictures' bucket.
CREATE POLICY "Public Read Access"
ON storage.objects FOR SELECT
USING ( bucket_id = 'profile-pictures' );

-- Allow anyone to upload new files into the 'profile-pictures' bucket.
CREATE POLICY "Public Insert Access"
ON storage.objects FOR INSERT
WITH CHECK ( bucket_id = 'profile-pictures' );

-- Allow anyone to update/replace existing files (for the upsert:true option).
CREATE POLICY "Public Update Access"
ON storage.objects FOR UPDATE
USING ( bucket_id = 'profile-pictures' );


-- Step 3: Remove 'shop' feature from businesses table.
-- First, drop the existing constraint
ALTER TABLE public.businesses
DROP CONSTRAINT IF EXISTS businesses_default_profile_tab_check;

-- Then, add the new constraint without 'shop'
ALTER TABLE public.businesses
ADD CONSTRAINT businesses_default_profile_tab_check
CHECK (default_profile_tab IN ('posts', 'discounts', 'about'));

-- Finally, drop the products table
DROP TABLE IF EXISTS public.products;


-- Step 4: Ensure previous migration changes are present for completeness.
ALTER TABLE public.customers
ADD COLUMN IF NOT EXISTS profile_picture_url text;

ALTER TABLE public.posts
ADD COLUMN IF NOT EXISTS post_type text NOT NULL DEFAULT 'standard',
ADD COLUMN IF NOT EXISTS video_url text,
ADD COLUMN IF NOT EXISTS price_text text,
ADD COLUMN IF NOT EXISTS external_url text;

CREATE OR REPLACE FUNCTION search_memberships_for_business(business_id_param uuid, search_term_param text)
RETURNS SETOF memberships AS $$
BEGIN
    IF search_term_param = '' OR search_term_param IS NULL THEN
        RETURN QUERY
        SELECT m.*
        FROM public.memberships m
        WHERE m.business_id = business_id_param
        ORDER BY m.updated_at DESC;
    ELSE
        RETURN QUERY
        SELECT m.*
        FROM public.memberships m
        JOIN public.customers c ON m.customer_id = c.id
        WHERE
            m.business_id = business_id_param
            AND (
                c.name ILIKE '%' || search_term_param || '%'
                OR c.phone_number ILIKE '%' || search_term_param || '%'
                OR c.qr_token = search_term_param
                OR c.id::text ILIKE search_term_param || '%'
            );
    END IF;
END;
$$ LANGUAGE plpgsql;

-- ================================================================
-- PREVIOUS MIGRATION COMPLETE
-- ================================================================
